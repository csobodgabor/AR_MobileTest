<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AR Demo - Mobil kompatibilis</title>
<style>
  body, html {
    margin: 0;
    overflow: hidden;
    background: black;
    font-family: sans-serif;
  }
  video {
    position: fixed;
    top: 0; left: 0;
    width: 100vw;
    height: 100vh;
    object-fit: cover;
    z-index: -1;
  }
  canvas {
    position: fixed;
    top: 0; left: 0;
    width: 100vw;
    height: 100vh;
    pointer-events: none; /* Canvas nem blokkolja az esem√©nyeket */
  }
  #info {
    position: absolute;
    top: 10px; left: 10px;
    color: white;
    background: rgba(0,0,0,0.7);
    padding: 8px 12px;
    border-radius: 8px;
    white-space: pre-line;
    font-size: 12px;
    z-index: 10;
  }
  #startButton {
    position: absolute; 
    top: 50%; 
    left: 50%;
    transform: translate(-50%, -50%);
    padding: 1em 2em;
    font-size: 1.2em;
    border-radius: 10px;
    border: none;
    background: #007bff;
    color: white;
    cursor: pointer;
    z-index: 20;
  }
  #startButton:hover {
    background: #0056b3;
  }
</style>
</head>
<body>

<div id="info">Nyomd meg az "AR ind√≠t√°sa" gombot az enged√©lyekhez.</div>
<button id="startButton">AR ind√≠t√°sa</button>
<video id="camera" autoplay playsinline muted></video>
<canvas id="overlay"></canvas>

<script>
const info = document.getElementById("info");
const startButton = document.getElementById("startButton");
const video = document.getElementById("camera");
const canvas = document.getElementById("overlay");
const ctx = canvas.getContext("2d");

let isRunning = false;
let orientation = { alpha: 0, beta: 0, gamma: 0 };
let position = { lat: 0, lon: 0, accuracy: 0 };

// Canvas m√©ret be√°ll√≠t√°sa √©s √∫jram√©retez√©s kezel√©se
function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}

resizeCanvas();
window.addEventListener('resize', resizeCanvas);

// üé• Kamera ind√≠t√°sa
async function startCamera() {
  try {
    const constraints = {
      video: {
        facingMode: "environment",
        width: { ideal: 1280 },
        height: { ideal: 720 }
      }
    };
    const stream = await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject = stream;
    
    return new Promise((resolve) => {
      video.onloadedmetadata = () => {
        video.play();
        resolve();
      };
    });
  } catch (e) {
    console.error("Kamera hiba:", e);
    info.innerText = "Nem siker√ºlt el√©rni a kamer√°t: " + e.message;
    throw e;
  }
}

// üß≠ Giroszk√≥p/orient√°ci√≥ ind√≠t√°sa
async function startOrientation() {
  try {
    // iOS enged√©ly k√©r√©se
    if (typeof DeviceOrientationEvent.requestPermission === 'function') {
      const permission = await DeviceOrientationEvent.requestPermission();
      if (permission !== 'granted') {
        throw new Error('Az orient√°ci√≥s enged√©ly megtagadva');
      }
    }
    
    // Esem√©nykezel≈ë hozz√°ad√°sa
    const handleOrientation = (e) => {
      orientation.alpha = e.alpha || 0;
      orientation.beta = e.beta || 0;
      orientation.gamma = e.gamma || 0;
    };
    
    window.addEventListener('deviceorientation', handleOrientation);
    
    // Teszt hogy m≈±k√∂dik-e
    setTimeout(() => {
      if (orientation.alpha === 0 && orientation.beta === 0 && orientation.gamma === 0) {
        console.warn("Az orient√°ci√≥s adatok nem √©rkeznek meg");
      }
    }, 1000);
    
  } catch (e) {
    console.error("Orient√°ci√≥ hiba:", e);
    info.innerText = "Orient√°ci√≥ hiba: " + e.message;
  }
}

// üìç GPS ind√≠t√°sa
function startGPS() {
  if (!navigator.geolocation) {
    console.error("Geolocation nem t√°mogatott");
    info.innerText = "A b√∂ng√©sz≈ë nem t√°mogatja a geolocation API-t.";
    return;
  }
  
  const options = {
    enableHighAccuracy: true,
    timeout: 10000,
    maximumAge: 60000
  };
  
  navigator.geolocation.watchPosition(
    (pos) => {
      position.lat = pos.coords.latitude;
      position.lon = pos.coords.longitude;
      position.accuracy = pos.coords.accuracy;
    },
    (err) => {
      console.error("GPS hiba:", err);
      switch(err.code) {
        case err.PERMISSION_DENIED:
          info.innerText = "GPS enged√©ly megtagadva";
          break;
        case err.POSITION_UNAVAILABLE:
          info.innerText = "GPS poz√≠ci√≥ nem el√©rhet≈ë";
          break;
        case err.TIMEOUT:
          info.innerText = "GPS id≈ët√∫ll√©p√©s";
          break;
        default:
          info.innerText = "Ismeretlen GPS hiba: " + err.message;
          break;
      }
    },
    options
  );
}

// üîÑ AR render loop (teszt objektum)
function loop() {
  if (!isRunning) return;
  
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // Egyszer≈± z√∂ld kocka a k√©perny≈ë k√∂zep√©n, ami forg√°s k√∂zben mozog
  const cx = canvas.width / 2;
  const cy = canvas.height / 2;
  const size = 50 + 20 * Math.sin(Date.now() / 500);

  ctx.save();
  ctx.translate(cx, cy);
  ctx.rotate((orientation.alpha || 0) * Math.PI / 180);
  ctx.strokeStyle = "rgba(0,255,0,0.8)";
  ctx.lineWidth = 4;
  ctx.strokeRect(-size/2, -size/2, size, size);
  
  // Kereszt a k√∂zep√©n
  ctx.strokeStyle = "rgba(255,255,255,0.6)";
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(-10, 0);
  ctx.lineTo(10, 0);
  ctx.moveTo(0, -10);
  ctx.lineTo(0, 10);
  ctx.stroke();
  
  ctx.restore();

  // Inform√°ci√≥s sz√∂veg friss√≠t√©se
  const hasGPS = position.lat !== 0 || position.lon !== 0;
  const hasOrientation = orientation.alpha !== 0 || orientation.beta !== 0 || orientation.gamma !== 0;
  
  info.innerText = 
    `üìç GPS: ${hasGPS ? `${position.lat.toFixed(5)}, ${position.lon.toFixed(5)} (¬±${position.accuracy?.toFixed(0)}m)` : 'V√°rakoz√°s...'}\n` +
    `üß≠ Orient√°ci√≥: ${hasOrientation ? `Œ±:${orientation.alpha.toFixed(1)}¬∞ Œ≤:${orientation.beta.toFixed(1)}¬∞ Œ≥:${orientation.gamma.toFixed(1)}¬∞` : 'V√°rakoz√°s...'}`;

  requestAnimationFrame(loop);
}

// üé¨ Ind√≠t√°s gomb esem√©ny
startButton.addEventListener('click', async () => {
  try {
    startButton.disabled = true;
    startButton.innerText = 'Ind√≠t√°s...';
    
    // P√°rhuzamos ind√≠t√°s
    await Promise.all([
      startCamera(),
      startOrientation()
    ]);
    
    startGPS();
    
    startButton.style.display = 'none';
    isRunning = true;
    loop();
    
  } catch (error) {
    console.error('Ind√≠t√°si hiba:', error);
    startButton.disabled = false;
    startButton.innerText = 'AR ind√≠t√°sa';
    info.innerText = 'Hiba t√∂rt√©nt: ' + error.message;
  }
});

// Takar√≠t√°s oldal elhagy√°sakor
window.addEventListener('beforeunload', () => {
  isRunning = false;
  if (video.srcObject) {
    video.srcObject.getTracks().forEach(track => track.stop());
  }
});
</script>

</body>
</html>
